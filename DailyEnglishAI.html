<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI è‹±èªæ•™ç·´ v3.0 (å¤šå…ƒé¡Œå‹)</title>
    <style>
        :root {
            --primary: #6c5ce7;
            --secondary: #a29bfe;
            --success: #00b894;
            --danger: #d63031;
            --bg: #f5f6fa;
            --card: #ffffff;
            --text: #2d3436;
        }

        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }

        body {
            margin: 0; padding: 0; background-color: var(--bg); color: var(--text);
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }

        header {
            background: var(--primary); color: white; padding: 15px; text-align: center;
            font-size: 1.1rem; font-weight: bold; flex-shrink: 0;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        #settings-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: white; padding: 0 10px;}

        #app { flex: 1; padding: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center; overflow-y: auto; }

        .card {
            background: var(--card); border-radius: 20px; padding: 25px; width: 100%; max-width: 450px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.08); text-align: center; animation: fadeIn 0.4s ease;
            position: relative; display: flex; flex-direction: column; align-items: center;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        h2 { margin: 0 0 10px 0; color: var(--primary); }
        p { color: #636e72; line-height: 1.6; }

        /* Inputs */
        input[type="text"], input[type="password"] {
            width: 100%; padding: 15px; border: 2px solid #dfe6e9; border-radius: 12px; 
            font-size: 1.1rem; margin: 15px 0; outline: none; transition: 0.3s;
            background: #fdfdfd;
        }
        input:focus { border-color: var(--primary); background: #fff; }

        /* Buttons */
        button.action-btn {
            background: var(--primary); color: white; border: none; padding: 15px; border-radius: 50px;
            font-size: 1rem; cursor: pointer; width: 100%; font-weight: bold; margin-top: 10px;
            transition: transform 0.1s, background 0.2s;
            box-shadow: 0 4px 6px rgba(108, 92, 231, 0.2);
        }
        button.action-btn:active { transform: scale(0.98); }
        button.secondary { background: #b2bec3; box-shadow: none; color: #2d3436; }
        
        /* Multiple Choice Buttons */
        .options-grid {
            display: grid; grid-template-columns: 1fr; gap: 10px; width: 100%; margin: 15px 0;
        }
        .option-btn {
            background: white; border: 2px solid #dfe6e9; padding: 15px; border-radius: 12px;
            font-size: 1rem; cursor: pointer; text-align: left; transition: 0.2s; color: #2d3436;
        }
        .option-btn:hover { border-color: var(--secondary); background: #f8f9fa; }
        .option-btn.selected { border-color: var(--primary); background: #eef2ff; color: var(--primary); font-weight: bold; }
        .option-btn.correct { border-color: var(--success); background: #e6fffa; color: var(--success); }
        .option-btn.wrong { border-color: var(--danger); background: #fff5f5; color: var(--danger); }

        /* Loader */
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%;
            width: 35px; height: 35px; animation: spin 1s linear infinite; margin: 20px auto; display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Components */
        .badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; margin-bottom: 15px; background: #eef2ff; color: var(--primary); font-weight: bold; letter-spacing: 0.5px; text-transform: uppercase;}
        .feedback { margin-top: 15px; font-weight: bold; min-height: 24px; padding: 10px; border-radius: 8px; width: 100%; }
        .feedback.correct { background: #e6fffa; color: var(--success); }
        .feedback.wrong { background: #fff5f5; color: var(--danger); }
        
        .screen { display: none; width: 100%; flex-direction: column; align-items: center; }
        .active { display: flex; }
        
        .progress-bar-bg { width: 100%; background: #dfe6e9; height: 6px; border-radius: 3px; margin-bottom: 20px; overflow: hidden;}
        .progress-bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s ease; }
        
        /* Mic Button */
        button.mic-btn {
            background: white; border: 2px solid #dfe6e9; width: 60px; height: 60px; border-radius: 50%; 
            margin: 0 auto; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; cursor: pointer;
            transition: 0.2s; color: #636e72;
        }
        button.mic-btn.listening { background: #ff7675; border-color: #ff7675; color: white; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 118, 117, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(255, 118, 117, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 118, 117, 0); } }

        /* API Modal */
        #api-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(2px);
            display: none; justify-content: center; align-items: center; z-index: 100;
        }
        .modal-content { max-height: 85vh; overflow-y: auto; text-align: left; }
    </style>
</head>
<body>

<header>
    <span>Daily English AI v3.0</span>
    <button id="settings-btn" onclick="openApiModal()">âš™ï¸</button>
</header>

<div id="api-modal">
    <div class="card modal-content">
        <h3 style="margin-top:0;">è¨­å®š (Settings)</h3>
        
        <label style="font-size:0.9rem; font-weight:bold;">API Key:</label>
        <input type="password" id="api-key-input" placeholder="è²¼ä¸Š Google Gemini API Key...">
        
        <label style="font-size:0.9rem; font-weight:bold; margin-top:10px;">Model Name:</label>
        <input type="text" id="model-name-input" value="gemini-2.0-flash-exp">
        
        <button class="action-btn" onclick="saveSettings()">å„²å­˜ (Save)</button>
        <button class="action-btn secondary" onclick="closeApiModal()">å–æ¶ˆ (Cancel)</button>
    </div>
</div>

<div id="app">
    <div id="screen-home" class="screen active card">
        <h2>ğŸ‘‹ Welcome!</h2>
        <div class="badge" id="level-display">Level: Beginner</div>
        <p>ä»Šæ—¥æŒ‘æˆ°ï¼š<b>20 å€‹å¤šå…ƒé¡Œå‹</b><br>åŒ…å«å–®å­—ã€æ–‡æ³•ã€æ”¹éŒ¯èˆ‡æƒ…å¢ƒå°è©±ã€‚</p>
        
        <div class="loader" id="ai-loader"></div>
        <p id="loading-text" style="display:none; font-size:0.9rem; color:#666;">AI æ­£åœ¨è¨­è¨ˆé¡Œåº«ä¸­...</p>

        <div style="width: 100%; margin: 15px 0; background: #f1f2f6; padding: 15px; border-radius: 12px; font-size: 0.9rem; text-align:left;">
            <strong>ğŸ“Š å­¸ç¿’æ•¸æ“š:</strong> <br>
            <span id="last-log" style="color:#636e72;">å°šç„¡ç´€éŒ„</span>
        </div>

        <button onclick="startQuiz()" id="start-btn" class="action-btn">ğŸš€ é–‹å§‹ä»Šæ—¥ç‰¹è¨“</button>
    </div>

    <div id="screen-quiz" class="screen" style="display:none;">
        <div style="display:flex; justify-content:space-between; width:100%; max-width:450px; color:#636e72; font-size:0.9rem; margin-bottom:8px;">
            <span id="q-counter">Q: 1/20</span>
            <span id="score-display">Score: 0</span>
        </div>
        <div class="progress-bar-bg"><div class="progress-bar-fill" id="progress-bar"></div></div>

        <div class="card">
            <div class="badge" id="q-type">TYPE</div>
            
            <h3 id="q-text" style="font-size: 1.25rem; margin: 10px 0 25px 0; line-height: 1.4;">Question...</h3>
            
            <div id="input-area" style="width:100%;">
                <input type="text" id="answer-input" placeholder="Type answer..." autocomplete="off">
                <div style="display:flex; justify-content:center; gap:15px;">
                    <button class="mic-btn" id="mic-btn" onclick="toggleSpeech()">ğŸ¤</button>
                </div>
            </div>

            <div id="choice-area" class="options-grid" style="display:none;">
                </div>

            <div id="feedback-msg" class="feedback" style="display:none;"></div>

            <button onclick="submitAnswer()" id="submit-btn" class="action-btn">é€å‡º (Submit)</button>
            <button onclick="nextQuestion()" id="next-btn" class="action-btn secondary" style="display:none;">ä¸‹ä¸€é¡Œ (Next)</button>
        </div>
    </div>

    <div id="screen-result" class="screen card" style="display:none;">
        <h2>ğŸ‰ å®ŒæˆæŒ‘æˆ°ï¼</h2>
        <h1 id="final-score" style="color: var(--primary); font-size: 3.5rem; margin: 10px 0;">0</h1>
        <p id="level-adjustment-msg">Analyzing performance...</p>
        <button onclick="goHome()" class="action-btn">å›é¦–é </button>
    </div>
</div>

<script>
    // --- Configuration ---
    const TOTAL_QUESTIONS = 20;
    let apiKey = localStorage.getItem('gemini_api_key') || '';
    let modelName = localStorage.getItem('gemini_model_name') || 'gemini-2.0-flash-exp';

    let userState = {
        level: 1, 
        history: []
    };

    // State for current session
    let currentSession = { questions: [], currentIndex: 0, score: 0, selectedOption: null };

    // --- Core: Prompt Engineering (The Magic) ---
    async function generateQuestions(level) {
        if (!apiKey) { alert("è«‹å…ˆè¨­å®š API Key"); return null; }

        const levelNames = ["Beginner", "Elementary", "Intermediate", "Upper-Intermediate", "Advanced"];
        const levelName = levelNames[level - 1] || "Beginner";

        // æ›´è¤‡é›œçš„ Promptï¼Œè¦æ±‚å¤šæ¨£åŒ–é¡Œå‹
        const prompt = `
            Act as an expert English teacher. Generate ${TOTAL_QUESTIONS} distinct English questions for a "${levelName}" level student.
            
            You MUST mix these 4 types of questions randomly:
            1. "translate": Chinese to English translation (e.g., words or sentences).
            2. "grammar": Fill in the blank (user types the missing word).
            3. "choice": Multiple choice grammar or vocabulary (provide 3-4 options).
            4. "fix": Give a sentence with ONE error, user must type the CORRECTED version (or just the corrected word).

            STRICT JSON RESPONSE FORMAT (No Markdown):
            [
                { 
                    "type": "translate", 
                    "q": "è˜‹æœçš„è‹±æ–‡æ˜¯ï¼Ÿ", 
                    "a": "apple" 
                },
                { 
                    "type": "choice", 
                    "q": "She ___ to school yesterday.", 
                    "options": ["go", "went", "gone"], 
                    "a": "went" 
                },
                {
                    "type": "fix",
                    "q": "Correct the error: He don't like pizza.",
                    "a": "doesn't"
                }
            ]
            
            Rules:
            - Answer "a" should be concise. 
            - For "fix" type, accept the full corrected sentence OR the keyword.
            - Provide variety in topics (daily life, travel, business).
        `;

        const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            const data = await response.json();
            if (data.error) throw new Error(data.error.message || "API Error");

            let rawText = data.candidates[0].content.parts[0].text;
            rawText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
            return JSON.parse(rawText);

        } catch (error) {
            console.error(error);
            alert("ç”Ÿæˆå¤±æ•—: " + error.message + "\nè«‹å˜—è©¦æ›´æ› Model åç¨±ã€‚");
            return null;
        }
    }

    // --- App Logic ---
    window.onload = function() {
        loadData();
        updateHomeUI();
        document.getElementById('api-key-input').value = apiKey;
        document.getElementById('model-name-input').value = modelName;
        if(!apiKey) openApiModal();
    };

    function loadData() {
        const saved = localStorage.getItem('engApp_user_v3');
        if (saved) userState = JSON.parse(saved);
    }
    function saveData() { localStorage.setItem('engApp_user_v3', JSON.stringify(userState)); }

    async function startQuiz() {
        toggleLoader(true);
        const questions = await generateQuestions(userState.level);
        toggleLoader(false);

        if (questions && questions.length > 0) {
            currentSession.questions = questions;
            currentSession.currentIndex = 0;
            currentSession.score = 0;
            showScreen('screen-quiz');
            renderQuestion();
        }
    }

    function renderQuestion() {
        const q = currentSession.questions[currentSession.currentIndex];
        
        // Update Header Stats
        document.getElementById('q-counter').innerText = `Q: ${currentSession.currentIndex + 1}/${TOTAL_QUESTIONS}`;
        document.getElementById('score-display').innerText = `Score: ${currentSession.score}`;
        document.getElementById('progress-bar').style.width = `${((currentSession.currentIndex) / TOTAL_QUESTIONS) * 100}%`;
        
        // Reset UI Elements
        document.getElementById('feedback-msg').style.display = 'none';
        document.getElementById('feedback-msg').className = 'feedback';
        document.getElementById('submit-btn').style.display = 'block';
        document.getElementById('next-btn').style.display = 'none';
        document.getElementById('mic-btn').classList.remove('listening');

        // Set Question Content
        document.getElementById('q-type').innerText = q.type.toUpperCase();
        document.getElementById('q-text').innerText = q.q;

        // Render based on Type
        const inputArea = document.getElementById('input-area');
        const choiceArea = document.getElementById('choice-area');
        const inputField = document.getElementById('answer-input');

        if (q.type === 'choice') {
            // Mode: Multiple Choice
            inputArea.style.display = 'none';
            choiceArea.style.display = 'grid';
            choiceArea.innerHTML = ''; // clear old buttons
            currentSession.selectedOption = null;

            q.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = opt;
                btn.onclick = () => selectOption(btn, opt);
                choiceArea.appendChild(btn);
            });
        } else {
            // Mode: Text Input (translate, grammar, fix)
            inputArea.style.display = 'block';
            choiceArea.style.display = 'none';
            inputField.value = '';
            inputField.disabled = false;
            inputField.focus();
        }
    }

    // For Multiple Choice Selection
    function selectOption(btnElement, text) {
        // Clear previous selection
        document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
        btnElement.classList.add('selected');
        currentSession.selectedOption = text;
    }

    function submitAnswer() {
        const q = currentSession.questions[currentSession.currentIndex];
        let userAns = "";

        if (q.type === 'choice') {
            if (!currentSession.selectedOption) return; // No selection
            userAns = currentSession.selectedOption;
        } else {
            userAns = document.getElementById('answer-input').value.trim();
            if (!userAns) return;
        }

        // Check Answer Logic
        const correctAns = q.a.toLowerCase().trim();
        const userAnsLower = userAns.toLowerCase().trim();
        const cleanUser = userAnsLower.replace(/[^\w\s]/gi, ''); // simple cleanup
        const cleanCorrect = correctAns.replace(/[^\w\s]/gi, '');

        // Flexible matching (checks strict, clean, or inclusion for long sentences)
        let isCorrect = (cleanUser === cleanCorrect) || (userAnsLower === correctAns);
        
        // Special logic for "fix" questions: if user types full correct sentence
        if (q.type === 'fix' && userAnsLower.includes(correctAns)) isCorrect = true;

        const feedbackEl = document.getElementById('feedback-msg');
        feedbackEl.style.display = 'block';

        if (isCorrect) {
            currentSession.score++;
            feedbackEl.innerText = "âœ… Excellent! Correct.";
            feedbackEl.classList.add('correct');
            // Visual feedback for buttons
            if(q.type === 'choice') document.querySelector('.option-btn.selected').classList.add('correct');
        } else {
            feedbackEl.innerText = `âŒ Wrong. Answer: ${q.a}`;
            feedbackEl.classList.add('wrong');
            if(q.type === 'choice') {
                document.querySelector('.option-btn.selected').classList.add('wrong');
                // Highlight real answer
                document.querySelectorAll('.option-btn').forEach(btn => {
                    if(btn.innerText.toLowerCase() === correctAns) btn.classList.add('correct');
                });
            }
        }

        // Lock inputs
        if(q.type !== 'choice') document.getElementById('answer-input').disabled = true;
        else document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);

        document.getElementById('submit-btn').style.display = 'none';
        document.getElementById('next-btn').style.display = 'block';
    }

    function nextQuestion() {
        currentSession.currentIndex++;
        if (currentSession.currentIndex < TOTAL_QUESTIONS) renderQuestion();
        else finishQuiz();
    }

    function finishQuiz() {
        const percentage = Math.round((currentSession.score / TOTAL_QUESTIONS) * 100);
        document.getElementById('final-score').innerText = percentage;

        let msg = "Level Unchanged.";
        if (percentage >= 80 && userState.level < 5) {
            userState.level++;
            msg = "Level Up! â¬†ï¸ AI å°‡æå‡é¡Œç›®é›£åº¦ã€‚";
        } else if (percentage <= 50 && userState.level > 1) {
            userState.level--;
            msg = "Level Down â¬‡ï¸ AI å°‡èª¿æ•´ç‚ºåŸºç¤é¡Œç›®ã€‚";
        }

        document.getElementById('level-adjustment-msg').innerText = msg;
        userState.history.push({ date: new Date().toLocaleDateString(), score: percentage });
        saveData();
        showScreen('screen-result');
    }

    // --- Helpers ---
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById(id).style.display = 'flex';
    }
    
    function toggleLoader(show) {
        document.getElementById('start-btn').style.display = show ? 'none' : 'block';
        document.getElementById('ai-loader').style.display = show ? 'block' : 'none';
        document.getElementById('loading-text').style.display = show ? 'block' : 'none';
    }

    function updateHomeUI() {
        const levels = ["Start", "Beginner", "Elementary", "Intermediate", "Upper-Intermediate", "Advanced"];
        document.getElementById('level-display').innerText = `Level ${userState.level}: ${levels[userState.level] || "Master"}`;
        
        if (userState.history.length > 0) {
            const last = userState.history[userState.history.length - 1];
            document.getElementById('last-log').innerText = `ğŸ“… ${last.date} | åˆ†æ•¸: ${last.score}%`;
        }
    }

    // Settings Modal
    function openApiModal() { document.getElementById('api-modal').style.display = 'flex'; }
    function closeApiModal() { document.getElementById('api-modal').style.display = 'none'; }
    function saveSettings() {
        apiKey = document.getElementById('api-key-input').value.trim();
        modelName = document.getElementById('model-name-input').value.trim();
        localStorage.setItem('gemini_api_key', apiKey);
        localStorage.setItem('gemini_model_name', modelName);
        closeApiModal();
        alert("è¨­å®šå·²æ›´æ–°ï¼");
    }

    // Speech Recognition
    let recognition;
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = 'en-US';
        recognition.continuous = false;
        recognition.interimResults = false;

        recognition.onstart = () => { document.getElementById('mic-btn').classList.add('listening'); };
        recognition.onend = () => { document.getElementById('mic-btn').classList.remove('listening'); };
        recognition.onresult = (event) => {
            let text = event.results[0][0].transcript;
            document.getElementById('answer-input').value = text.replace(/\.$/, "");
        };
    } else { document.getElementById('mic-btn').style.display = 'none'; }
    function toggleSpeech() { if(recognition) try { recognition.start(); } catch(e) { recognition.stop(); } }
</script>
</body>
</html>